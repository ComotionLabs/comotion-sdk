
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>comotion.dash &#8212; Comotion Python SDK Docs</title>
    <link rel="stylesheet" href="../../_static/material.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=white data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#_modules/comotion/dash" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../index.html" title="Comotion Python SDK Docs"
           class="md-header-nav__button md-logo">
          
              <img src="../../_static/comotion_logo.png" height="26"
                   alt="comotion-sdk logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Comotion Python SDK</span>
          <span class="md-header-nav__topic"> comotion.dash </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/ComotionLabs/comotion-sdk/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    comotion-sdk
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="../../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../../"versions.json"",
        target_loc = "../../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../../index.html" class="md-tabs__link">comotion-sdk</a></li>
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">Module code</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../index.html" title="Comotion Python SDK Docs" class="md-nav__button md-logo">
      
        <img src="../../_static/comotion_logo.png" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../index.html"
       title="Comotion Python SDK Docs">Comotion Python SDK</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/ComotionLabs/comotion-sdk/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    comotion-sdk
  </div>
</a>
    </div>
  
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
  <ul class="md-nav__list" data-md-scrollfix="">
    

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <h1 id="modules-comotion-dash--page-root">Source code for comotion.dash</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cx_Oracle</span>
    <span class="kn">import</span> <span class="nn">sqlalchemy</span>
    <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">comotion</span> <span class="kn">import</span> <span class="n">Auth</span>
<span class="kn">from</span> <span class="nn">comotion</span> <span class="kn">import</span> <span class="n">comodash_api_client_lowlevel</span>
<span class="kn">from</span> <span class="nn">comodash_api_client_lowlevel.comodash_api</span> <span class="kn">import</span> <span class="n">queries_api</span>
<span class="kn">from</span> <span class="nn">comodash_api_client_lowlevel.model.query_text</span> <span class="kn">import</span> <span class="n">QueryText</span>
<span class="kn">from</span> <span class="nn">urllib3.exceptions</span> <span class="kn">import</span> <span class="n">IncompleteRead</span>
<span class="kn">from</span> <span class="nn">urllib3.response</span> <span class="kn">import</span> <span class="n">HTTPResponse</span>
<span class="kn">from</span> <span class="nn">comodash_api_client_lowlevel.model.query</span> <span class="kn">import</span> <span class="n">Query</span> <span class="k">as</span> <span class="n">QueryInfo</span>

<div class="viewcode-block" id="DashConfig"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.DashConfig">[docs]</a><span class="k">class</span> <span class="nc">DashConfig</span><span class="p">(</span><span class="n">comodash_api_client_lowlevel</span><span class="o">.</span><span class="n">Configuration</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Object containing configuration information for Dash API</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    auth : comotion.Auth</span>
<span class="sd">        comotion.Auth object holding information about authentication</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auth</span><span class="p">:</span> <span class="n">Auth</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">Auth</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"auth must be of type comotion.Auth"</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="s1">'https://</span><span class="si">%s</span><span class="s1">.api.comodash.io/v2'</span> <span class="o">%</span> <span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">orgname</span><span class="p">),</span>
            <span class="n">access_token</span><span class="o">=</span><span class="n">auth</span><span class="o">.</span><span class="n">get_access_token</span><span class="p">()</span>
        <span class="p">)</span></div>

        <span class="c1"># comodash_api_client_lowlevel.Configuration.set_default(config)</span>


<div class="viewcode-block" id="Query"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.Query">[docs]</a><span class="k">class</span> <span class="nc">Query</span><span class="p">():</span>
    <span class="sd">"""</span>
<span class="sd">    The query object starts and tracks a query on Comotion Dash.</span>

<span class="sd">    Initialising this class runs a query on Comotion Dash and stores the</span>
<span class="sd">    resulting query id in `query_id`</span>

<span class="sd">    """</span>

    <span class="n">COMPLETED_STATES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'SUCCEEDED'</span><span class="p">,</span> <span class="s1">'CANCELLED'</span><span class="p">,</span> <span class="s1">'FAILED'</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">DashConfig</span><span class="p">,</span>
        <span class="n">query_text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">query_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query_text : str</span>
<span class="sd">            sql of the query to run</span>
<span class="sd">        config : DashConfig</span>
<span class="sd">            Object of type DashConfig including configuration details</span>
<span class="sd">        query_id : str, optional</span>
<span class="sd">            Query id of existing query.  If not provided, then a new query will be started on Dash</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If config is not of type DashConfig</span>

<span class="sd">        ValueError</span>
<span class="sd">            if one of query_id or query_text is not provided</span>

<span class="sd">        """</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">DashConfig</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"config must be of type comotion.dash.DashConfig"</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">comodash_api_client_lowlevel</span><span class="o">.</span><span class="n">ApiClient</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">api_client</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_api_instance</span> <span class="o">=</span> <span class="n">queries_api</span><span class="o">.</span><span class="n">QueriesApi</span><span class="p">(</span><span class="n">api_client</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">query_id</span><span class="p">:</span>
                <span class="n">query_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_api_instance</span><span class="o">.</span><span class="n">get_query</span><span class="p">(</span><span class="n">query_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_id</span> <span class="o">=</span> <span class="n">query_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_text</span> <span class="o">=</span> <span class="n">query_info</span><span class="o">.</span><span class="n">query</span>
            <span class="k">elif</span> <span class="n">query_text</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_text</span> <span class="o">=</span> <span class="n">query_text</span>
                <span class="n">query_text_model</span> <span class="o">=</span> <span class="n">QueryText</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_text</span><span class="p">)</span>
                <span class="n">query_id_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_api_instance</span><span class="o">.</span><span class="n">run_query</span><span class="p">(</span><span class="n">query_text_model</span><span class="p">)</span> <span class="c1"># noqa</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_id</span> <span class="o">=</span> <span class="n">query_id_model</span><span class="p">[</span><span class="s1">'query_id'</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"One of query_id or query_text must be provided"</span><span class="p">)</span>

<div class="viewcode-block" id="Query.get_query_info"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.Query.get_query_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_query_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryInfo</span><span class="p">:</span>
        <span class="sd">"""Gets the state of the query.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        QueryInfo</span>
<span class="sd">            Model containing all query info, with the following attributes</span>

<span class="sd">            `query`</span>
<span class="sd">                query sql</span>
<span class="sd">            `query_id`</span>
<span class="sd">                query_id of query</span>
<span class="sd">            `status`</span>
<span class="sd">                `completion_date_time`</span>
<span class="sd">                    GMT Completion Time</span>
<span class="sd">                `state`</span>
<span class="sd">                    Current state of query. One of QUEUED,RUNNING,SUCCEEDED,FAILED,CANCELLED</span>
<span class="sd">                `stateChangeReason`</span>
<span class="sd">                    info about reason for state change (generally failure)</span>
<span class="sd">                submission_date_time`</span>
<span class="sd">                    GMT submission time</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_api_instance</span><span class="o">.</span><span class="n">get_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.state"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.Query.state">[docs]</a>    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Gets the state of the query.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            One of QUEUED,RUNNING,SUCCEEDED,FAILED,CANCELLED</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_query_info</span><span class="p">()</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span></div>

<div class="viewcode-block" id="Query.is_complete"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.Query.is_complete">[docs]</a>    <span class="k">def</span> <span class="nf">is_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">"""Indicates whether the query is in a final state.</span>
<span class="sd">        This means it has either succeeded, failed or been cancelled.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Whether query complete</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">()</span> <span class="ow">in</span> <span class="n">Query</span><span class="o">.</span><span class="n">COMPLETED_STATES</span></div>

<div class="viewcode-block" id="Query.wait_to_complete"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.Query.wait_to_complete">[docs]</a>    <span class="k">def</span> <span class="nf">wait_to_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">"""Blocks until query is in a complete state</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Final state, one of 'SUCCEEDED', 'CANCELLED', 'FAILED'</span>
<span class="sd">        """</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">query_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_query_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">query_info</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">Query</span><span class="o">.</span><span class="n">COMPLETED_STATES</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">query_info</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.query_id"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.Query.query_id">[docs]</a>    <span class="k">def</span> <span class="nf">query_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Returns query id for this query</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_id</span></div>

<div class="viewcode-block" id="Query.get_csv_for_streaming"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.Query.get_csv_for_streaming">[docs]</a>    <span class="k">def</span> <span class="nf">get_csv_for_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HTTPResponse</span><span class="p">:</span>
        <span class="sd">""" Returns a ``urllib3.response.HTTPResponse`` object that can be used for streaming</span>
<span class="sd">            This allows use of the downloaded file without having to save</span>
<span class="sd">            it to local storage.</span>

<span class="sd">            Be sure to use ``.release_conn()`` when completed to ensure that the</span>
<span class="sd">            connection is released</span>

<span class="sd">            This can be achieved using the `with` notation e.g.::</span>

<span class="sd">                with query.get_csv_for_streaming().stream() as stream:</span>
<span class="sd">                  for chunk in stream:</span>
<span class="sd">                      # do somthing with chunk</span>
<span class="sd">                      # chunk is a byte array ``</span>
<span class="sd">        """</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_api_instance</span><span class="o">.</span><span class="n">download_csv</span><span class="p">(</span>
            <span class="n">query_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query_id</span><span class="p">,</span>
            <span class="n">_preload_content</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">autoclose</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="Query.download_csv"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.Query.download_csv">[docs]</a>    <span class="k">def</span> <span class="nf">download_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file_path</span><span class="p">,</span> <span class="n">fail_if_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""Download csv of results and check that the total file size is correct</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_file_path : File path</span>
<span class="sd">            Path of the file to output to</span>
<span class="sd">        fail_if_exists : bool, optional</span>
<span class="sd">            If true, then will fail if the target file name already/</span>
<span class="sd">            Defaults to false.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IncompleteRead</span>
<span class="sd">            If only part of the file is downloaded, this is raised</span>
<span class="sd">        """</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_csv_for_streaming</span><span class="p">()</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">write_mode</span> <span class="o">=</span> <span class="s2">"wb"</span>
            <span class="k">if</span> <span class="n">fail_if_exists</span><span class="p">:</span>
                <span class="n">write_mode</span> <span class="o">=</span> <span class="s2">"xb"</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="n">write_mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">content_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s1">'Content-Length'</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="mi">1048576</span><span class="p">):</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">content_length</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">IncompleteRead</span><span class="p">(</span>
                        <span class="n">response</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span> <span class="o">-</span> <span class="n">response</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    <span class="p">)</span></div>

<div class="viewcode-block" id="Query.stop"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.Query.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">""" Stop the query"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_api_instance</span><span class="o">.</span><span class="n">stop_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_id</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="upload_csv_to_dash"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.upload_csv_to_dash">[docs]</a><span class="k">def</span> <span class="nf">upload_csv_to_dash</span><span class="p">(</span>
    <span class="n">dash_orgname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="c1"># noqa</span>
    <span class="n">dash_api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dash_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">csv_gz_stream</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="p">,</span>
    <span class="n">service_client_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'0'</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
    <span class="sd">"""Uploads csv gzipped stream to Dash</span>

<span class="sd">    Expects a csv gzipped stream to upload to dash.</span>

<span class="sd">    Args:</span>
<span class="sd">        dash_orgname (str): Dash organisation name for dash instance</span>
<span class="sd">        dash_api_key (str): Valid API key for the organisation instance</span>
<span class="sd">        dash_table (str): Table name to upload to</span>

<span class="sd">        csv_gz_stream (io.FileIO): Description</span>

<span class="sd">    Returns:</span>
<span class="sd">        requests.Response: response from dash api</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPError: If one is raised by the call</span>
<span class="sd">    """</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s2">"https://api.comodash.io/v1/data-input-file"</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/gzip'</span><span class="p">,</span>
        <span class="s1">'service_client_id'</span><span class="p">:</span> <span class="n">service_client_id</span><span class="p">,</span>
        <span class="s1">'x-api-key'</span><span class="p">:</span> <span class="n">dash_api_key</span><span class="p">,</span>
        <span class="s1">'org-name'</span><span class="p">:</span> <span class="n">dash_orgname</span><span class="p">,</span>
        <span class="s1">'table-name'</span><span class="p">:</span> <span class="n">dash_table</span>
    <span class="p">}</span>

    <span class="n">dash_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
        <span class="s2">"POST"</span><span class="p">,</span>
        <span class="n">url</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">csv_gz_stream</span><span class="o">.</span><span class="n">getbuffer</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">dash_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">dash_response</span></div>


<div class="viewcode-block" id="create_gzipped_csv_stream_from_df"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.create_gzipped_csv_stream_from_df">[docs]</a><span class="k">def</span> <span class="nf">create_gzipped_csv_stream_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">:</span>
    <span class="sd">"""Returns a gzipped, utf-8 csv file bytestream from a pandas dataframe</span>

<span class="sd">    Useful to help upload dataframes to dash</span>

<span class="sd">    It does not break file up, so be sure to apply a maximise chunksize</span>
<span class="sd">    to the dataframe before applying - otherwise dash max file limits will</span>
<span class="sd">    cause an error</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Dateframe to be turned into bytestream</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    io.BytesIO</span>
<span class="sd">        The Bytestream</span>

<span class="sd">    """</span>

    <span class="n">csv_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="n">csv_stream</span><span class="p">,</span>
        <span class="n">compression</span><span class="o">=</span><span class="s2">"gzip"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONNUMERIC</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">csv_stream</span></div>


<div class="viewcode-block" id="read_and_upload_file_to_dash"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.read_and_upload_file_to_dash">[docs]</a><span class="k">def</span> <span class="nf">read_and_upload_file_to_dash</span><span class="p">(</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="p">],</span>
    <span class="n">dash_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dash_orgname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dash_api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'utf-8'</span><span class="p">,</span>
    <span class="n">chunksize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">,</span>
    <span class="n">modify_lambda</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">path_to_output_for_dryrun</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">service_client_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'0'</span>
<span class="p">):</span>
    <span class="sd">"""Reads a file and uploads to dash.</span>

<span class="sd">    This function will:</span>
<span class="sd">    - Read a csv file</span>
<span class="sd">    - Break it up into multiple csv's</span>
<span class="sd">    - each with a maximum number of lines defined by chunksize</span>
<span class="sd">    - upload them to dash</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : Union[str, io.FileIO]</span>
<span class="sd">        Either a path to the file to be uploaded,</span>
<span class="sd">        or a FileIO stream representing the file to be uploaded</span>
<span class="sd">        Should be an unencrypted, uncompressed CSV file</span>
<span class="sd">    dash_table: str</span>
<span class="sd">        name of Dash table to upload the file to</span>
<span class="sd">    dash_orgname: str</span>
<span class="sd">        orgname of your Dash instance</span>
<span class="sd">    dash_api_key: str</span>
<span class="sd">        valid api key for Dash API</span>
<span class="sd">    encoding: str</span>
<span class="sd">        the encoding of the source file.  defaults to utf-8.</span>
<span class="sd">    chunksize: int</span>
<span class="sd">        (optional)</span>
<span class="sd">        the maximum number of lines to be included in each file.</span>
<span class="sd">        Note that this should be low enough that the zipped file is less</span>
<span class="sd">        than Dash maximum gzipped file size. Defaults to 30000.</span>
<span class="sd">    modify_lambda:</span>
<span class="sd">        (optional)</span>
<span class="sd">        a callable that recieves the pandas dataframe read from the</span>
<span class="sd">        csv.  Gives the opportunity to modify - such as adding a timestamp</span>
<span class="sd">        column.</span>
<span class="sd">        Is not required.</span>
<span class="sd">    path_to_output_for_dryrun: str</span>
<span class="sd">        (optional)</span>
<span class="sd">        if specified, no upload will be made to dash, but files</span>
<span class="sd">        will be saved to the location specified. This is useful for</span>
<span class="sd">        testing.</span>
<span class="sd">        multiple files will be created: [table_name].[i].csv.gz where i</span>
<span class="sd">        represents multiple file parts</span>
<span class="sd">    service_client_id: str</span>
<span class="sd">        (optional)</span>
<span class="sd">        if specified, specifies the service client for the upload. See the dash documentation for an explanation of service client.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List</span>
<span class="sd">        List of http responses</span>
<span class="sd">    """</span>
    <span class="n">file_reader</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">file</span><span class="p">,</span>
        <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span>  <span class="c1"># Set all columns to strings.  Dash will still infer the type, but this makes sure it doesnt mess with the contents of the csv before upload</span>
    <span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file_df</span> <span class="ow">in</span> <span class="n">file_reader</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">modify_lambda</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">modify_lambda</span><span class="p">(</span><span class="n">file_df</span><span class="p">)</span>


        <span class="n">csv_stream</span> <span class="o">=</span> <span class="n">create_gzipped_csv_stream_from_df</span><span class="p">(</span><span class="n">file_df</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path_to_output_for_dryrun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">upload_csv_to_dash</span><span class="p">(</span>
                <span class="n">dash_orgname</span><span class="o">=</span><span class="n">dash_orgname</span><span class="p">,</span>
                <span class="n">dash_api_key</span><span class="o">=</span><span class="n">dash_api_key</span><span class="p">,</span>
                <span class="n">dash_table</span><span class="o">=</span><span class="n">dash_table</span><span class="p">,</span>
                <span class="n">csv_gz_stream</span><span class="o">=</span><span class="n">csv_stream</span><span class="p">,</span>
                <span class="n">service_client_id</span><span class="o">=</span><span class="n">service_client_id</span>
            <span class="p">)</span>

            <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span>
                    <span class="n">path_to_output_for_dryrun</span><span class="p">,</span>
                    <span class="n">dash_table</span> <span class="o">+</span> <span class="s2">"."</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">".csv.gz"</span>
                <span class="p">),</span>
                <span class="s2">"wb"</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">csv_stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">responses</span></div>

<div class="viewcode-block" id="upload_from_oracle"><a class="viewcode-back" href="../../comotion.dash.html#comotion.dash.upload_from_oracle">[docs]</a><span class="k">def</span> <span class="nf">upload_from_oracle</span><span class="p">(</span> 
    <span class="n">sql_host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">sql_port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
    <span class="n">sql_service_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">sql_username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">sql_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">sql_query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>   
    <span class="n">dash_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">dash_orgname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">dash_api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">dtypes</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">include_snapshot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
    <span class="n">export_csvs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
    <span class="n">chunksize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">,</span> 
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s1">'</span><span class="se">\t</span><span class="s1">'</span><span class="p">,</span> 
    <span class="n">max_tries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span> 
<span class="p">):</span> 
    <span class="sd">"""</span>
<span class="sd">    Uploads data from a Oracle SQL database object to dash. </span>

<span class="sd">    This function will: </span>
<span class="sd">    - get the total number of rows chunks need for the sql query</span>
<span class="sd">    - get chunks of data from the SQL database </span>
<span class="sd">    - upload them to dash </span>
<span class="sd">    - append them to csv output (if specified)</span>
<span class="sd">    - save error chunks as csv (if any) </span>

<span class="sd">    Parameters </span>
<span class="sd">    ---------- </span>
<span class="sd">    sql_host: str</span>
<span class="sd">        SQL hot e.g. '192.168.0.0.1'</span>
<span class="sd">    sql_port: str</span>
<span class="sd">        SQL port number e.g 9005</span>
<span class="sd">    sql_service_name: str</span>
<span class="sd">        SQL service name e.g. 'myservice' </span>
<span class="sd">    sql_username: str </span>
<span class="sd">        SQL username, </span>
<span class="sd">    sql_password: str  </span>
<span class="sd">        SQL password, </span>
<span class="sd">    sql_query: str  </span>
<span class="sd">        SQL query,  </span>
<span class="sd">    dash_table: str </span>
<span class="sd">        name of Dash table to upload the data to </span>
<span class="sd">    dash_orgname: str </span>
<span class="sd">        orgname of your Dash instance </span>
<span class="sd">    dash_api_key: str </span>
<span class="sd">        valid api key for Dash API </span>
<span class="sd">    export_csvs: </span>
<span class="sd">        (optional) </span>
<span class="sd">        If True, data successfully uploaded is exported as csv </span>
<span class="sd">        Defaults to True i.e. output is included </span>
<span class="sd">    dtypes: dict </span>
<span class="sd">        (optional) </span>
<span class="sd">        A dictionary that contains the column name and data type to convert to. </span>
<span class="sd">        Defaults to None i.e. load dataframe columns as they are. </span>
<span class="sd">    chunksize: int </span>
<span class="sd">        (optional) </span>
<span class="sd">        the maximum number of lines to be included in each file. </span>
<span class="sd">        Note that this should be low enough that the zipped file is less </span>
<span class="sd">        than Dash maximum gzipped file size. </span>
<span class="sd">        Defaults to 50000. </span>
<span class="sd">    sep: str </span>
<span class="sd">        (optional) </span>
<span class="sd">        Field delimiter for ComoDash table to upload the dataframe to. </span>
<span class="sd">        Defaults to /t. </span>
<span class="sd">    output_path: str </span>
<span class="sd">        (optional) </span>
<span class="sd">        if specified, no output csv are saved in that location. If not, output is place in the same location as the script</span>
<span class="sd">        Defaults to None </span>
<span class="sd">    include_snapshot: bool </span>
<span class="sd">        (optional) </span>
<span class="sd">        If True, an additional column 'snapshot_timestamp' will be added to the DataFrame. </span>
<span class="sd">        This column will contain the time that data is loaded in "%Y-%m-%d %H:%M:%S.%f" </span>
<span class="sd">        format in order to help with database management </span>
<span class="sd">        Defaults to True i.e. snapshot_timestamp is included </span>
<span class="sd">    max_tries: int </span>
<span class="sd">        (optional) </span>
<span class="sd">        Maximum number of times to retry if there is an HTTP error </span>
<span class="sd">        Defaults to 5 </span>
<span class="sd">    Returns </span>
<span class="sd">    ------- </span>
<span class="sd">    pd.DataFrame </span>
<span class="sd">        DataFrame with errors </span>
<span class="sd">    """</span> 

    <span class="c1"># Initialize data upload  </span>
      
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Initializing. This will take a little while.."</span><span class="p">)</span> 
    
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"https://api.comodash.io/v1/data-input-file"</span> 

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> 
        <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/gzip'</span><span class="p">,</span> 
        <span class="s1">'service_client_id'</span><span class="p">:</span> <span class="s1">'0'</span><span class="p">,</span> 
        <span class="s1">'x-api-key'</span><span class="p">:</span> <span class="n">dash_api_key</span><span class="p">,</span> 
        <span class="s1">'org-name'</span><span class="p">:</span> <span class="n">dash_orgname</span><span class="p">,</span> 
        <span class="s1">'table-name'</span><span class="p">:</span> <span class="n">dash_table</span> 
    <span class="p">}</span> 

    <span class="n">snapshot_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> 

    <span class="c1"># Create load id </span>
    <span class="n">load_id</span> <span class="o">=</span> <span class="n">dash_table</span> <span class="o">+</span> <span class="s2">"_"</span> <span class="o">+</span> <span class="n">snapshot_timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">%H%M"</span><span class="p">)</span> 

    <span class="c1"># Create output folder </span>
    <span class="k">if</span> <span class="n">export_csvs</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span> 
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> 

    <span class="c1"># Create log file</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">load_id</span> <span class="o">+</span> <span class="s2">".log"</span><span class="p">)</span> 
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span> 
        <span class="n">fmt</span><span class="o">=</span><span class="s1">'</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)-12s</span><span class="s1"> </span><span class="si">%(levelname)-8s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">'</span><span class="p">,</span> 
        <span class="n">datefmt</span><span class="o">=</span><span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1">,%H:%M:%S'</span> 
    <span class="p">)</span> 
    <span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span> 
    <span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>    
    
    <span class="c1"># Create logger</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span> 
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span> 
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span> 

    <span class="c1"># Create sqlalchemy engine </span>
    <span class="n">sql_dsn</span> <span class="o">=</span> <span class="n">cx_Oracle</span><span class="o">.</span><span class="n">makedsn</span><span class="p">(</span><span class="n">sql_host</span><span class="p">,</span> <span class="n">sql_port</span><span class="p">,</span> <span class="n">service_name</span><span class="o">=</span><span class="n">sql_service_name</span><span class="p">)</span> 
    <span class="n">connection_string</span> <span class="o">=</span> <span class="s1">'oracle://</span><span class="si">{user}</span><span class="s1">:</span><span class="si">{password}</span><span class="s1">@</span><span class="si">{dsn}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">sql_username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">sql_password</span><span class="p">,</span> <span class="n">dsn</span><span class="o">=</span><span class="n">sql_dsn</span><span class="p">)</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">connection_string</span><span class="p">,</span> <span class="n">max_identifier_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span> 

    <span class="c1"># Connect to database </span>
    <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span> 

        <span class="c1"># Table properties </span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)</span> 
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span> 
        
        <span class="c1"># Calculate results length </span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">"select count(*) from (</span><span class="si">{sql_query}</span><span class="s2">)"</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 

        <span class="k">if</span> <span class="n">length</span> <span class="o">%</span> <span class="n">chunksize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">chunk_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="n">chunksize</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">chunk_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="n">chunksize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> 

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Starting to upload table with </span><span class="si">{length}</span><span class="s2"> rows in </span><span class="si">{chunk_number}</span><span class="s2"> chunks."</span><span class="p">)</span> 
  
        <span class="c1"># Empty list to store chunks that fail to upload </span>
        <span class="n">error_chunks</span> <span class="o">=</span> <span class="p">[]</span>   

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">load_id</span> <span class="o">+</span> <span class="s2">"_success.csv.gz"</span><span class="p">),</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> 
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">chunk_number</span><span class="p">)):</span> 

                <span class="c1"># Get data chunk</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="n">chunksize</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span> 

                <span class="c1"># Include snapshort time if include_snapshot == True </span>
                <span class="k">if</span> <span class="n">include_snapshot</span><span class="p">:</span> 
                    <span class="n">chunk</span><span class="p">[</span><span class="s1">'snapshot_timestamp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot_timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S.</span><span class="si">%f</span><span class="s2">"</span><span class="p">)</span> 
                    
                <span class="c1"># Change columns format if dtypes is specified </span>
                <span class="k">if</span> <span class="n">dtypes</span><span class="p">:</span> 
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span> 

                <span class="c1"># Create gz_stream </span>
                <span class="n">csv_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span> 
            
                <span class="n">chunk</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span> 
                    <span class="n">csv_stream</span><span class="p">,</span> 
                    <span class="n">compression</span><span class="o">=</span><span class="s2">"gzip"</span><span class="p">,</span> 
                    <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">,</span> 
                    <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                    <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span><span class="p">,</span> 
                    <span class="n">sep</span><span class="o">=</span><span class="n">sep</span> 
                <span class="p">)</span> 

                <span class="n">trial</span> <span class="o">=</span> <span class="mi">1</span> 

                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> 
                    <span class="k">try</span><span class="p">:</span> 
                        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span> 
                            <span class="n">method</span><span class="o">=</span><span class="s2">"POST"</span><span class="p">,</span> 
                            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> 
                            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> 
                            <span class="n">data</span><span class="o">=</span><span class="n">csv_stream</span><span class="o">.</span><span class="n">getbuffer</span><span class="p">()</span> 
                        <span class="p">)</span> 

                        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span> 

                        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span> 

                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> 

                            <span class="n">trial</span> <span class="o">=</span> <span class="mi">1</span> 

                            <span class="k">if</span> <span class="n">export_csvs</span><span class="p">:</span>                        
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">csv_stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span> 

                            <span class="k">break</span> 
                    <span class="k">except</span><span class="p">:</span> 

                        <span class="k">if</span> <span class="n">trial</span> <span class="o">&gt;=</span> <span class="n">max_tries</span><span class="p">:</span> 

                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> 

                            <span class="n">error_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> 

                            <span class="n">trial</span> <span class="o">=</span> <span class="mi">1</span> 

                            <span class="k">break</span> 

                        <span class="k">else</span><span class="p">:</span> 
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> 

                            <span class="k">if</span> <span class="n">export_csvs</span><span class="p">:</span>                        
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">csv_stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span> 
                            <span class="n">trial</span> <span class="o">+=</span> <span class="mi">1</span> 

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Data uploaded with {len(error_chunks)} error files"</span><span class="p">)</span> 

    <span class="c1"># Combine error chunks and export them as csv </span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_chunks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 

        <span class="nb">print</span><span class="p">(</span><span class="s2">"Exporting errors..."</span><span class="p">)</span> 
        
        <span class="n">error_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">error_chunks</span><span class="p">)</span> 

        <span class="n">error_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span> 
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">load_id</span> <span class="o">+</span> <span class="s2">"_fail.csv.gz"</span><span class="p">),</span> 
            <span class="n">compression</span><span class="o">=</span><span class="s2">"gzip"</span><span class="p">,</span> 
            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">sep</span><span class="o">=</span><span class="n">sep</span> 
        <span class="p">)</span> 

        <span class="k">return</span> <span class="n">error_df</span> 

    <span class="k">else</span><span class="p">:</span> 
        <span class="k">return</span> <span class="kc">None</span></div>
</pre></div>

          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2021, Comotion Business Solutions.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 2.4.4.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>